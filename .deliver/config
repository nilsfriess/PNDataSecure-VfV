APP="report"

BUILD_HOST="18.184.8.213"
BUILD_USER="ubuntu"
BUILD_AT="/home/ubuntu/builds"

STAGING_HOSTS="18.184.8.213"
STAGING_USER="ubuntu"
TEST_AT="/home/ubuntu/dev"

PRODUCTION_HOSTS="18.184.8.213"
PRODUCTION_USER="ubuntu"
DELIVER_TO="/home/ubuntu/prod"

pre_erlang_get_and_update_deps() {
  local _prod_secret_path="/home/ubuntu/config/prod.secret.exs"
  local _dev_secret_path="/home/ubuntu/config/dev.secret.exs"

  if [ "$TRAVIS_BRANCH" == "production" ]; then
    status "Starting production build"
    __sync_remote "
      sed -i '/export PORT=/c\export PORT=4000' /home/ubuntu/.profile
      source /home/ubuntu/.profile
      ln -sfn '$_prod_secret_path' '$BUILD_AT/config/prod.secret.exs'
    "
  elif [ "$TRAVIS_BRANCH" == "development" ]; then
    status "Starting development build"
    __sync_remote "
      sed -i '/export PORT=/c\export PORT=4040' /home/ubuntu/.profile
      source /home/ubuntu/.profile
      touch $BUILD_AT/config/prod.secret.exs
      ln -sfn '$_dev_secret_path' '$BUILD_AT/config/prod.secret.exs'
    "
  fi
}

pre_erlang_clean_compile() {
  status "Installing NPM dependencies"
  __sync_remote "
    [ -f ~/.profile ] && source ~/.profile
    set -e

    cd '$BUILD_AT/assets'
    npm install $SILENCE
  "

  status "Building static files"
  __sync_remote "
    [ -f ~/.profile ] && source ~/.profile
    set -e

    cd '$BUILD_AT'
    mkdir -p priv/static

    cd 'assets'
    npm run deploy $SILENCE
  "

  status "Running phoenix.digest"
  __sync_remote "
    [ -f ~/.profile ] && source ~/.profile
    set -e

    cd '$BUILD_AT'
    APP='$APP' MIX_ENV='$TARGET_MIX_ENV' $MIX_CMD phoenix.digest $SILENCE
  "
}